<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>My Fly Italy Adsb</title>
</head>

<link rel="stylesheet" href="/static/style.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="config.js"></script>

<p id="benvenuto" class="display-1 p-3">Aerei in arrivo....</p>
<br>
<div id="menu" class="container-fluid d-none justify-content-center align-items-center">
    <div class="row ">
        <div class="col-md-auto text-center">
            <form method="post">
                {{ form.Sito(class="btn btn-light btn-block") }}
            </form>
        </div>
        <div class="col-md-auto text-center">
            <form method="post">
                {{ form.Mappa_my(class="btn btn-light btn-block") }}
            </form>
        </div>
        <div class="col-md-auto text-center">
            <form method="post">
                {{ form.Report(class="btn btn-light btn-block") }}
            </form>
        </div>
        <div class="col-md-auto text-center">
            <form method="post">
                {{ form.Mappa(class="btn btn-light btn-block") }}
            </form>
        </div>
        <div class="col-md-auto text-center">
            <form method="post">
                {{ form.Grafici(class="btn btn-light btn-block") }}
            </form>
        </div>
    </div>
</div>

<div class="row mt-5 mb-0">
    <div class="col-md-auto text-center">

        <form method="get" action="/table" id="searchForm" class="d-none form p-3">
            <div class="d-flex align-items-center">
                <label class="form-label">
<input type="text" class="form-control" name="search" value="{{ request.query_params.get('search', '') }}" placeholder="Cerca...">

                </label>
                <label class="form-label">
                    <select name="sort_by" class="form-select">
                        <option value="hex" {% if request.query_params.get('sort_by', '') == 'hex' %}selected{% endif %}>ICAO
                        </option>
                        <option value="Registrazione"
                                {% if request.query_params.get('sort_by', '') == 'Registrazione' %}selected{% endif %}>
                            Registrazione
                        </option>
                        <option value="flight" {% if request.query_params.get('sort_by', '') == 'flight' %}selected{% endif %}>
                            Callsign
                        </option>
                        <option value="squawk" {% if request.query_params.get('sort_by', '') == 'squawk' %}selected{% endif %}>
                            Squawk
                        </option>
                        <option value="Operatore"
                                {% if request.query_params.get('sort_by', '') == 'Operatore' %}selected{% endif %}>
                            Operatore
                        </option>
                    </select>
                </label>
                <button type="submit" class="paper-plane-button ms-2"><i class="fas fa-paper-plane"></i></button>
                <button type="button" id="clear_search" class="x-button ms-2" style="display:none;"><i
                        class="fa-regular fa-circle-xmark"></i></button>
            </div>
        </form>
    </div>

    <div class="col-md-auto text-center">

        <form id="slider_form" method="post" class=" form p-3 d-none">
            <label for="raggio">{{ posizione.raggio.label.text }}</label>
            <div class="d-flex align-items-center">
                {{ posizione.raggio(class="form-range", id="raggio", type="range", min="0", max="500", oninput='outputUpdate(value)', value= request.state.session.raggio |default(250)) }}
                <button type="submit" class="paper-plane-button ms-2"><i class="fas fa-paper-plane"></i></button>
                <button type="button" id="clear_posizione" class="x-button ms-2" style="display:none;"><i
                        class="fa-regular fa-circle-xmark"></i></button>

            </div>
            <output for="raggio" id="selected-raggio">
                {% if  request.state.session.raggio %}{{  request.state.session.raggio }} {% else %}250 {% endif %}</output>
        </form>
    </div>

    <div class="col-md-auto text-center">

        <form id="mio" method="post" class=" form p-3 d-none">
            <label for="raggio">{{ mio.only_mine.label.text }}</label>
            <div class="d-flex align-items-center">
                {{ mio.only_mine(class="form-select") }}
                <button type="submit" class="paper-plane-button ms-2"><i class="fas fa-paper-plane"></i></button>
                <button type="button" id="clear_mio" class="x-button ms-2" style="display:none;"><i
                        class="fa-regular fa-circle-xmark"></i></button>

            </div>
        </form>
    </div>

</div>
<div class="row">

</div>

<div id="mappa"></div>

<div id="report_voli" class="table-responsive pt-0 px-3 m-0"></div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>



    let mappa = L.map('mappa').setView([stazioneCentrale.lat, stazioneCentrale.lon], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mappa);

    // Aggiungi la stazione centrale
    L.marker([stazioneCentrale.lat, stazioneCentrale.lon]).addTo(mappa)
        .bindPopup(stazioneCentrale.nome)
        .openPopup();

    // Aggiungi le stazioni collegate e disegna una linea per collegarle alla stazione centrale
    stazioniCollegate.forEach(stazione => {
        L.marker([stazione.lat, stazione.lon]).addTo(mappa)
            .bindPopup(stazione.nome);

        L.polyline([
            [stazioneCentrale.lat, stazioneCentrale.lon],
            [stazione.lat, stazione.lon]
        ]).addTo(mappa);
    });


function update() {
    $.ajax({
        type: 'GET',
        url: '/selected_page',
        success: function (data) {
            let currentPage = data.selected_page;
            let filter = data.filtered;
            let sort = data.sorted;

            let params = [];

            if (currentPage !== null) {
                params.push("page=" + currentPage);
            }

            if (filter !== null) {
                params.push("search=" + filter);
            }

            if (sort !== null) {
                params.push("sort_by=" + sort);
            }

            let queryString = params.join('&');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    document.getElementById("benvenuto").innerHTML = "My Fly Italy Adsb - passirano";
                    document.getElementById("benvenuto").classList.add("centrale");
                    var elements = document.querySelectorAll('.d-none');
                    elements.forEach(function (element) {
                        element.classList.remove('d-none');
                    });
                    document.getElementById("menu").classList.add("d-flex");
                    document.getElementById("report_voli").innerHTML = this.responseText;
                }
            };

            xhttp.open("GET", "/table?" + queryString, true);
            xhttp.send();
        }
    });
}


    $(function () {
        $('body').on('click', '.pagination_link', function (e) {
            e.preventDefault();
            var url = "/table" + $(this).attr('href');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    document.getElementById("benvenuto").innerHTML = "My Fly Italy Adsb - {{ ricevitore.name if ricevitore.name else ricevitore.uuid}}";
                    document.getElementById("benvenuto").classList.add("centrale");
                    document.getElementById("menu").classList.remove("d-none");
                    var elements = document.querySelectorAll('.d-none');
                    elements.forEach(function (element) {
                        element.classList.remove('d-none');
                    });
                    document.getElementById("menu").classList.add("d-flex");

                    document.getElementById("report_voli").innerHTML = this.responseText;
                }
            }
            xhttp.open("GET", url + "&new_page=True", true);
            xhttp.send();

        });
    });

    $(document).ready(function () {
        $("#searchForm").submit(function (event) {
            event.preventDefault();

            // Ottieni i dati dal form
            var formData = $(this).serialize();
            // Esegui una richiesta AJAX al server
            $.ajax({
                url: '/table',
                type: 'GET',
                data: formData,
                success: function (response) {
                    // Carica la risposta del server nel div "report_voli"
                    $("#report_voli").html(response);
                    $("#clear_search").show()

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });
    $(document).ready(function () {
        $("#slider_form").submit(function (event) {
            event.preventDefault();
            // Ottieni i dati dal form
            var formData = $(this).serialize();
            // Esegui una richiesta AJAX al server
            $.ajax({
                url: '/session/posizione',
                type: 'POST',
                data: formData,
                success: function (response) {
                    $("#clear_posizione").show()
                    update()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });
    $(document).ready(function () {
        $("#mio").submit(function (event) {
            event.preventDefault();

            // Ottieni i dati dal form
            var formData = $(this).serialize();
            // Esegui una richiesta AJAX al server
            $.ajax({
                url: '/session/only_mine',
                type: 'POST',
                data: formData,
                success: function (response) {
                    $('#clear_mio').show();
                    update()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });

    $(document).ready(function () {
        $("#clear_search").click(function (event) {
            event.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: '/disattiva/search',
                type: 'POST',
                data: formData,
                success: function (response) {
                    $("#clear_search").hide()
                    update()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });
    $(document).ready(function () {
        $("#clear_posizione").click(function (event) {
            event.preventDefault();
            $.ajax({
                url: '/disattiva/posizione',
                type: 'POST',
                success: function (response) {
                    $("#clear_posizione").hide()
                    update()

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });
    $(document).ready(function () {
        $("#clear_mio").click(function (event) {
            event.preventDefault();
            $.ajax({
                url: '/disattiva/only_mine',
                type: 'POST',
                success: function (response) {
                    $("#clear_mio").hide()
                    update()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Errore nella richiesta AJAX:', textStatus, errorThrown);
                }
            });
        });
    });

    function outputUpdate(value) {
        document.getElementById('selected-raggio').textContent = value;
    }
    setInterval(update, 5000)
    update()

</script>
</html>


